---
title: "Programming for Data Science"
author: "Mathews Abraham"
date: "2024-05-28"
output: word_document
---

To start with the analysis, first the necessary libraries were called using the library function in R, there are mainly three libraries used throughout our analysis, ggplot, tidyverse and dplyr.  

```{r}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(knitr)
```

**Question 1.Write the code to analyse the distribution of COVID patients (confirmed or suspected) across countries. Write the code to investigate the distribution of the patients across age groups (e.g., 0-18, 19-35,36-50, 51+). Visualise both the findings using the histogram. Explain your findings.**

```{r}

patients1 = read.csv("patientsPG1.csv") #to load the csv files
patients2 = read.csv("patientsPG2.csv")
patients = rbind(patients1,patients2)
```
```{r}
conditions1 = read.csv("ConditionsPG1.csv")
conditions2 = read.csv("ConditionsPG2.csv")
condition = rbind(conditions1,conditions2)
conditions = subset(condition, DESCRIPTION %in% c("Suspected COVID-19","COVID-19"), drop = TRUE)#subsetting dataset based on the number of covid patients
```

As the task does not specifically mention to investigate the distribution in a particualar dataset, we have used the whole datasets here. 

Here we have four datasets, two of them contains patient demographic data and others contain  information about patient conditions. First, we read all the data using the 'read.csv' function in R, we used this function because the data is in a csv format. Then the dataset with demographic information was combined into one and the ones describing conditions into another single one.

First we are analyzing the distribution of covid patients across the counties, the patients data has information about the counties and the conditions have the description of the diagnosis. Since there were other information under the 'DESCRIPTION' variable but we are only interested if the patients have suspected covid or not, we filtered the dataset with the description of diagnosis either covid-19 or not.

```{r}
county = subset(patients, select = c("Id","COUNTY","BIRTHDATE"))
description = subset(conditions, select = c("PATIENT","DESCRIPTION"))
merged = merge(county,description, by.x = "Id",by.y = "PATIENT", all = FALSE)
head(merged,5)
```

From the patients dataset, as we do not need all the information, it was subsetted with information like Id, county name and birthdate because we need birthdates later for analysis. We also made an other set with just the patient id and description from the conditions and then the description of the diagnosis and county names were combined on the basis of patient id so that we can get the patients their respective counties and if they had covid or not. 

```{r}
covid = subset(merged, DESCRIPTION == "COVID-19", drop = TRUE)
s_covid = unique(merged$Id[!(merged$Id %in% covid$Id)])
sus_covid = merged[!(merged$Id %in% covid$Id),]
final = rbind(covid,sus_covid)
Q1 = subset(final,select = c("COUNTY","DESCRIPTION","BIRTHDATE"))

```

Now, we had to do some additional filtering, all the patients were suspected for covid first, but some of them did not turn covid positive. In the dataset, the ids are repeated for those who were suspected first and had covid later, so we had to remove these duplicate ids. First we took all the ids which had covid, this means these ids are repeated any way, then we filter the suspected covid ids then later further we filtered the unique suspected ids and finally binded back the unique ids together. 

```{r}
Q1_table = table(Q1$COUNTY,Q1$DESCRIPTION)
Q1.data = as.data.frame(Q1_table)
names(Q1.data) = c("COUNTY","DESCRIPTION","NO.OF.PEOPLE")
Q1.data  = Q1.data%>%
  arrange(desc(NO.OF.PEOPLE))

ggplot(Q1.data, aes(x = COUNTY, y = NO.OF.PEOPLE, fill = DESCRIPTION)) +
  geom_bar(stat = "identity",position = position_dodge(0.9),color ="darkgrey") +
  labs(title = "Suspected and Confirmed cases by Counties",x = "COUNTY",
       y = "No.of.People",
       fill = "Description") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r}
co.county = subset(Q1.data, DESCRIPTION == "COVID-19")
kable(co.county, caption = "COVID-19 patients across counties")
hist(co.county$NO.OF.PEOPLE, main = "Distribution of people with Covid-19 across counties",
     xlab = "No.of.People", col = "skyblue",border = "white")

```


```{r}
sus.county = subset(Q1.data, DESCRIPTION == "Suspected COVID-19")
kable(sus.county, caption = "Suspected COVID-19 patients across counties")
hist(sus.county$NO.OF.PEOPLE, main = "Distribution of people with Suspected Covid-19 across counties",
     xlab = "No.of.People", col = "cyan3",border = "white")
```

Now we have to find the distribution of covid patients across different age group, for this we have to categorise the ages into four different groups 0-18, 19-35, 36-50 and 51 +. Since we do not have the direct ages of patients, instead we calculated it from their date of birth using a function.

```{r}
age = subset(Q1, select = c("BIRTHDATE","DESCRIPTION"))
```

```{r}
age_calculator = function(dob) {
  today = Sys.Date()
  birth.date = as.Date(dob)
  
  birth.year = as.numeric(format(birth.date, "%Y"))
  current_year = as.numeric(format(today, "%Y"))
  
  age = current_year - birth.year
  
  bday = format(today, "%m-%d") < format(birth.date, "%m-%d")
  age[bday] = age[bday] - 1
  
  return(age)
}
```

```{r}

age$AGE = age_calculator(age$BIRTHDATE)
age = age %>%
  mutate(Age.group = case_when(
    AGE>=0 & AGE<=18 ~ "0-18",
    AGE>=19& AGE<=35 ~ "19-35",
    AGE>=36& AGE<=50 ~ "36-50",
    AGE>=51 ~ "51+"
  ))

```


```{r}
#age = subset(age,select = c("Age.group"))
age.table = table(age$DESCRIPTION,age$Age.group)
age.data = as.data.frame(age.table)
names(age.data) = c("DESCRIPTION","AGE.GROUP","NO.OF.PEOPLE")
age.data  = age.data%>%
  arrange(desc(NO.OF.PEOPLE))

ggplot(age.data, aes(x = AGE.GROUP, y = NO.OF.PEOPLE, fill = DESCRIPTION)) +
  geom_bar(stat = "identity",position = position_dodge(0.9),colour= "darkgrey") +
  labs(title = "Suspected and Confirmed cases by AGE GROUP",x = "Age Groups",
       y = "No.of.People",
       fill = "Description") +
  theme_bw()+
  scale_fill_manual(values = c("aquamarine2","darkcyan"))
  
```
```{r}
co.age = subset(age.data, DESCRIPTION == "COVID-19")
kable(co.age, caption = "COVID-19 patients across different age groups")
hist(co.age$NO.OF.PEOPLE, main = "Distribution of people with Covid-19 across different age groups",
     xlab = "No.of.People", col = "aquamarine4",border = "white")
```
```{r}
sus.age = subset(age.data, DESCRIPTION == "Suspected COVID-19")
kable(co.age, caption = "Suspected COVID-19 patients across different age groups")
hist(co.age$NO.OF.PEOPLE, main = "Distribution of people who suspected Covid-19 in different age groups",
     xlab = "No.of.People", col = "cyan3",border = "white")
```



```{r}
Q2 = subset(condition,select = c("PATIENT","DESCRIPTION"))
final  

Q2= Q2%>%
  filter(PATIENT %in% final$Id)


```

```{r}
symptom.count= Q2 %>%
  count(DESCRIPTION)

top.12 = symptom.count %>%
  top_n(12)

top.12 = top.12%>%
  arrange(desc(n))

top.12
top.10 = top.12%>%
  slice(-1,-2)
top.10
```
 

```{r}
Q2.1 = patients%>%
  filter(Id %in% Q2$PATIENT)

```

```{r}
gender = subset(Q2.1,select = c("Id","GENDER"))

gender.des = merge(gender,Q2, by.x = "Id",by.y = "PATIENT", all = FALSE)
```


```{r}
symptom.gender = gender.des %>%
  count(DESCRIPTION,GENDER)

symptom.gender

top.in.gender = symptom.gender%>%
  group_by(GENDER)%>%
  slice_max(order_by = n, n =12, with_ties = TRUE)
  
top.in.gender

reshaped = spread(top.in.gender,GENDER,n)

reshaped = reshaped%>%
  arrange(desc(c(reshaped$F)))

top.10.g = reshaped%>%
  slice(-1,-2)



```

```{r}

encounters1 = read.csv("encountersPG1.csv")
encounters2 = read.csv("encountersPG2.csv")

```

```{r}
#DATA_1

Q3 = encounters1%>%
  filter(PATIENT %in% Q4$PATIENT)
Q3 = subset(Q3, select = c("PATIENT","ENCOUNTERCLASS"))
Q3 = Q3[Q3$ENCOUNTERCLASS %in% c("ambulatory","emergency","inpatient","urgentcare"),]
table(Q3$ENCOUNTERCLASS)

Q3.1 = subset(patients1, select = c("Id","GENDER","RACE"))

Q3.2 = merge(Q3,Q3.1,by.x = "PATIENT", by.y = "Id",all = FALSE)

gender.encounter = table(Q3.2$ENCOUNTERCLASS,Q3.2$GENDER)
gender.encounter

ggplot(Q3.2, aes(x = ENCOUNTERCLASS, fill = GENDER)) +
  geom_bar(position = position_dodge(width = 0.9), color = "black") +
  labs(title = "ENCOUNTERCLASS BETWEEN GENDERS") + 
  theme_bw()+ scale_fill_manual(values = c("lightpink","skyblue"))


prop.gender.1 = prop.table(gender.encounter,margin = 1)*100
prop.gender.1

race.encounter = table(Q3.2$ENCOUNTERCLASS,Q3.2$RACE)
race.encounter

ggplot(Q3.2, aes(x = ENCOUNTERCLASS, fill = RACE)) +
  geom_bar(position = position_dodge(width = 0.9), color = "black") +
  labs(title = "ENCOUNTERCLASS BETWEEN RACE") + 
  theme_bw()


prop.race.1 = prop.table(race.encounter,margin = 1)*100
prop.race.1

```
```{r}
#DATA 2
Qn3 = encounters2%>%
  filter(PATIENT %in% Qn4$PATIENT)
Qn3 = subset(Qn3, select = c("PATIENT","ENCOUNTERCLASS"))
Qn3 = Qn3[Qn3$ENCOUNTERCLASS %in% c("ambulatory","emergency","inpatient","urgentcare"),]
table(Qn3$ENCOUNTERCLASS)

Qn3.1 = subset(patients2, select = c("Id","GENDER","RACE"))

Qn3.2 = merge(Qn3,Qn3.1,by.x = "PATIENT", by.y = "Id",all = FALSE)

gender.encounter2 = table(Qn3.2$ENCOUNTERCLASS,Qn3.2$GENDER)
gender.encounter2

ggplot(Qn3.2, aes(x = ENCOUNTERCLASS, fill = GENDER)) +
  geom_bar(position = position_dodge(width = 0.9), color = "black") +
  labs(title = "ENCOUNTERCLASS BETWEEN GENDERS") + 
  theme_bw()+ scale_fill_manual(values = c("lightpink","skyblue"))

prop.gedner.2 = prop.table(gender.encounter2,margin = 1)*100
prop.gedner.2

race.encounter2 = table(Qn3.2$ENCOUNTERCLASS,Qn3.2$RACE)
race.encounter2
ggplot(Qn3.2, aes(x = ENCOUNTERCLASS, fill = RACE)) +
  geom_bar(position = position_dodge(width = 0.9), color = "black") +
  labs(title = "ENCOUNTERCLASS BETWEEN GENDERS") + 
  theme_bw()

prop.race.2 = prop.table(race.encounter2,margin = 1)*100
prop.race.2


```

**Question.4**


```{r}
#DATA 1
covid.in.1 = subset(conditions1, DESCRIPTION == "COVID-19", drop = TRUE)
suspected.in.1 = subset(conditions1,DESCRIPTION == "Suspected COVID-19"&
                          !PATIENT %in% covid.in.1$PATIENT)
Q4 = rbind(covid.in.1,suspected.in.1)


```

```{r}
Q4$RECOVERY.STAT = ifelse(is.na(Q4$STOP)|Q4$STOP=="", "Not_recovered", "Recovered")
Q4$RECOVERY.TIME = as.Date(Q4$STOP)- as.Date(Q4$START)

Q4.table = table(Q4$DESCRIPTION,Q4$RECOVERY.STAT)
Q4.table

barplot(Q4.table,beside = TRUE,col = c("skyblue","lightpink"))

```
```{r}
patients1$AGE = age_calculator(patients1$BIRTHDATE)
patients1 = patients1 %>%
  mutate(AGE.GROUP = case_when(
    AGE>=0 & AGE<=18 ~ "0-18",
    AGE>=19& AGE<=35 ~ "19-35",
    AGE>=36& AGE<=50 ~ "36-50",
    AGE>=51 ~ "51+"
  ))

Q4.1 = subset(patients1,select = c("Id","AGE","AGE.GROUP","GENDER","ZIP"))

Q4.2 = Q4.1%>%
  filter(Id %in% Q4$PATIENT)

Q4.3 = merge(Q4,Q4.2,by.x = "PATIENT",by.y = "Id",all = FALSE)

Q4.final = subset(Q4.3,select = c("PATIENT","GENDER","AGE","AGE.GROUP",
                              "DESCRIPTION","ZIP","RECOVERY.STAT","RECOVERY.TIME"))
```


```{r}

REC.id.1 = subset(Q4, select = c("PATIENT","RECOVERY.STAT"))
SYM.1 = subset(conditions1,select = c("PATIENT","DESCRIPTION"))

SYM.1 = SYM.1%>%
  filter(PATIENT %in% REC.id.1$PATIENT)

REC.SYM.1 = merge(REC.id.1,SYM.1,by.x = "PATIENT","PATIENT",all = FALSE)

REC.SYM.table.1 = as.data.frame(table(REC.SYM.1$DESCRIPTION,REC.SYM.1$RECOVERY.STAT))

REC.SYM.table.1 = REC.SYM.table.1%>%
  arrange(desc(Freq))%>%
  slice(-1,-2)

REC.SYM.table.1 =REC.SYM.table.1%>%
  slice(-42,-43)

names(REC.SYM.table.1) = c("SYMPTOMS","RECOVERY.STAT","FREQUENCY.OF.SYMPTOMS")

REC.SYM.FREQ.1 = subset(REC.SYM.table.1, RECOVERY.STAT == "Recovered" )
NOT.REC.FREQ.1 = subset(REC.SYM.table.1, RECOVERY.STAT == "Not_recovered" )


```

```{r}
#DATA 2

covid.in.2 = subset(conditions2, DESCRIPTION == "COVID-19", drop = TRUE)
suspected.in.2 = subset(conditions2,DESCRIPTION == "Suspected COVID-19"&
                          !PATIENT %in% covid.in.2$PATIENT)
Qn4 = rbind(covid.in.2,suspected.in.2)

```

```{r}
Qn4$RECOVERY.STAT = ifelse(is.na(Qn4$STOP)|Qn4$STOP=="", "Not_recovered", "Recovered")
Qn4$RECOVERY.TIME = as.Date(Qn4$STOP)- as.Date(Qn4$START)

Qn4.table = table(Qn4$DESCRIPTION,Qn4$RECOVERY.STAT)
Qn4.table
```
```{r}
patients2$AGE = age_calculator(patients2$BIRTHDATE)
patients2 = patients2 %>%
  mutate(AGE.GROUP = case_when(
    AGE>=0 & AGE<=18 ~ "0-18",
    AGE>=19& AGE<=35 ~ "19-35",
    AGE>=36& AGE<=50 ~ "36-50",
    AGE>=51 ~ "51+"
  ))

Qn4.1 = subset(patients2,select = c("Id","AGE","AGE.GROUP","GENDER","ZIP"))

Qn4.2 = Qn4.1%>%
  filter(Id %in% Qn4$PATIENT)

Qn4.3 = merge(Qn4,Qn4.2,by.x = "PATIENT",by.y = "Id",all = FALSE)

Qn4.final = subset(Qn4.3,select = c("PATIENT","GENDER","AGE","AGE.GROUP",
                              "DESCRIPTION","ZIP","RECOVERY.STAT","RECOVERY.TIME"))
```

```{r}
REC.id.2 = subset(Qn4, select = c("PATIENT","RECOVERY.STAT"))
SYM.2 = subset(conditions2,select = c("PATIENT","DESCRIPTION"))

SYM.2 = SYM.2%>%
  filter(PATIENT %in% REC.id.2$PATIENT)

REC.SYM.2 = merge(REC.id.2,SYM.2,by.x = "PATIENT","PATIENT",all = FALSE)

REC.SYM.table.2 = as.data.frame(table(REC.SYM.2$DESCRIPTION,REC.SYM.2$RECOVERY.STAT))

REC.SYM.table.2 = REC.SYM.table.2%>%
  arrange(desc(Freq))%>%
  slice(-1,-2)

REC.SYM.table.2 =REC.SYM.table.2%>%
  slice(-42,-47)

names(REC.SYM.table.2) = c("SYMPTOMS","RECOVERY.STAT","FREQUENCY.OF.SYMPTOMS")

REC.SYM.FREQ.2 = subset(REC.SYM.table.2, RECOVERY.STAT == "Recovered" )
NOT.REC.FREQ.2 = subset(REC.SYM.table.2, RECOVERY.STAT == "Not_recovered" )
```

